# 底层协议

## [类型转换](src/command/variable_bytes.rs)

## 传输协议 `双向`

- 包头 `USB`

  - `命令总长度` < 192
    ```
    1e <1 byte 命令总长度> [命令...]
    ```
  - `命令总长度` >= 192
    ```
    1e <2 bytes 命令总长度> [命令...]
    ```
  
  > 破案了, 固件没有清零 USB 发送缓冲区, 所以会读到脏数据...

- 包头 `BLE`

  ```
  [命令...]
  ```

- 命令 `USB && BLE`

  命令按照顺序依次打包/解析

  - `数据长度` < 192
    ```
    <1 byte 命令组> <1 byte 命令类型> <1 byte 数据长度> [数据...] [1 byte 校验和 初始=0]
    ```
  - `数据长度` >= 192
    ```
    <1 byte 命令组> <1 byte 命令类型> <2 bytes 数据长度> [数据...] [1 byte 校验和 初始=0]
    ```
  - 校验和
    - 如果未启用校验, 则为 `0x88`
    - 否则使用[这个](src/command/checksum.rs)函数计算 `命令[1..命令长度]` 的校验和

## 命令列表 - 命令组 `0x1f`

- `0x4_` 打印设置
  - `0x40`
  - `0x41`
  - `0x42`
  - `0x43`
  - `0x44`
  - `0x45`
  - `0x46`
  - `0x47`
  - `0x48`
  - `0x49`
  - `0x4a`
  - `0x4b`
  - `0x4c`
  - `0x4d`
  - `0x4e`
  - `0x4f`

- `0x7_` 设备信息
  - `0x70` # TODO
  - `0x71` # TODO DPI
  - `0x72` # TODO
  - `0x73` # TODO
  - `0x74` (X)
  - `0x75` 制造商
  - `0x76` (X)
  - `0x77` # TODO
  - `0x78` # FIXME
  - `0x79` 设备名
  - `0x7a` # TODO
  - `0x7b` # TODO
  - `0x7c` 软件版本
  - `0x7d` # TODO 蓝牙mac地址
  - `0x7e` # TODO 打印机会重启
  - `0x7f` # TODO

### TODO

- 连接方式(# FIXME 任何参数都返回 `0x02 0x43`) `主机->设备` `0x78`
  - 参数 `BLE`
    - `[0]` `0x06` `(i8)`
  - 参数 `USB`
    - `[0]` `0x10` `(i8)`

- `0x70` # TODO `00, 01, 02, 00, 00, 35, 01, 10`

- `0x73` # TODO `00, 01, b6, 4b, 00, 01, 76, ce, 00, 00, 71, 58, 00, 00, 00, de`

- `0x77` # TODO `32, 00, 00, 00, 00, 88, 00`

- `0x7a` # TODO `0x26, 0x01, 0x04, 0x01, 0x04,`

- `0x7d` # TODO 蓝牙mac地址 `10, 60, 6e, 41, 37, c4, 37, 14, 60, 6e, 41, 37, c4, 37` `60:6e:41:37:c4:37`

- `0x71` # TODO DPI (300) `01, 2c`

- `0x72` # TODO `02, 40, 02, 3a, 00, 00, 00, 00, 00`

- `0x7b` # TODO `32`

- `0x7e` # TODO 打印机会重启

- `0x7f` # TODO `00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00, 00`

- (# FIXME) `设备->主机` `0x9f`

### 设备信息

#### 设备名

- (已验证) 读取设备名 `主机->设备` `0x79`
  - 无参数
- (已验证) 设备名 `设备->主机` `0x79`
  - `[..]` 以 `0x00` 结尾的设备名 `型号-序列号` `(str)`

#### 软件版本

- (已验证) 读取软件版本 `主机->设备` `0x7c`
  - 无参数
- (已验证) 软件版本 `设备->主机` `0x7c`
  - `[..]` 以 `0x00` 结尾的软件版本 `x.y yyyymmdd`

#### 制造商

- (已验证) 读取制造商 `主机->设备` `0x75`
  - 无参数
- (已验证) 制造商 `设备->主机` `0x75`
  - `[..]` 以 `0x00` 结尾的制造商名 `(str)`
    - `gbk` / `gb2312` 编码

#### 其他

- 读取信息 `主机->设备` `0x75`
  - (已验证) 无参数 制造商
  - 参数 系列 # FIXME
    - `[0]` `0x53`
  - 参数 内部型号 # FIXME
    - `[0]` `0x44`
- (已验证) 制造商 `设备->主机` `0x75`
  - `[..]` 以 `0x00` 结尾的制造商名 `(str)`
    - `gbk` / `gb2312` 编码
- 系列 `设备->主机` `0x75`  # FIXME
  - `[..]` 以 `0x00` 结尾的系列名 `(str)`
- 内部型号 `设备->主机` `0x75` # FIXME
  - `[..]` 以 `0x00` 结尾的内部型号名 `(str)`

### 打印设置

#### 打印浓度

- (已验证) 设置打印浓度 `主机->设备` `0x43`
  - 参数
    - `[0]` 要设置的浓度值 `(i8)`
      - `0x00` 最淡 1
      - ...
      - `0x03` 较淡 4
      - ...
      - `0x05` 正常 6
      - ...
      - `0x09` 较浓 10
      - ...
      - `0x0e` 最浓 15
- (已验证) 读取打印浓度 `主机->设备` `0x43`
  - 无参数
- (已验证) 打印浓度 `设备->主机` `0x43`
  - `[0]` 打印浓度
    - `0x00` 最淡 1
    - ...
    - `0x03` 较淡 4
    - ...
    - `0x05` 正常 6
    - ...
    - `0x09` 较浓 10
    - ...
    - `0x0e` 最浓 15

#### 打印速度

- (已验证) 设置打印速度 `主机->设备` `0x44`
  - 参数
    - `[0]` 要设置的打印速度值 `(i8)`
      - `0x00` 最慢 1
      - `0x01` 较慢 2
      - `0x02` 正常 3
      - `0x03` 较快 4
      - `0x04` 最快 5
- (已验证) 读取打印速度 `主机->设备` `0x44`
  - 无参数
- (已验证) 打印速度 `设备->主机` `0x44`
  - `[0]` 打印速度
    - `0x00` 最慢 1
    - `0x01` 较慢 2
    - `0x02` 正常 3
    - `0x03` 较快 4
    - `0x04` 最快 5

#### 打印纸类型

- (已验证) 设置打印纸类型 `主机->设备` `0x42`
  - 参数
    - `[0]` 要设置的打印纸类型 `(i8)`
      - `0x00` Ticket 小票纸
      - `0x02` Adhesive 不干胶
      - `0x03` CardPaper 卡纸
      - `0x04` Transparent 透明贴
- (已验证) 读取打印纸类型 `主机->设备` `0x42`
  - 无参数
- (已验证) 打印纸类型 `设备->主机` `0x42`
  - `[0]`
    - `0x00` Ticket 小票纸
    - `0x02` Adhesive 不干胶
    - `0x03` CardPaper 卡纸
    - `0x04` Transparent 透明贴

#### 打印纸间隔

- (已验证) 设置打印纸间隔 `主机->设备` `0x45`
  - 参数
    - `[0]` / `[1:0]` / `[2:0]` 要设置的打印纸间隔(0.01 mm)
      - 最小值 50 (0.5 mm)
- (已验证) 读取打印纸间隔 `主机->设备` `0x45`
  - 无参数
- (已验证) 打印纸间隔 `设备->主机` `0x45`
  - `[0]` / `[1:0]` / `[2:0]` 打印纸间隔(0.01 mm)

#### 其他

- 电机模式 `主机->设备` `0x47`
  - 参数
    - `[0]` 未知 `(i8)` # TODO `00`
